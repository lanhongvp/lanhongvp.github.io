<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #FFF0F5; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #FFF0F5, 0 0 5px     #FFF0F5; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #FFF0F5;    /*上边框颜色*/
        border-left-color: #FFF0F5;    /*左边框颜色*/
    }
</style>








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="Tensorflow," />










<meta name="description" content="欠下的帐总归还是要还的，之前一直拖着，总是懒得写tf.metrics这个API的一些用法，今天总算是克服了懒癌，总结一下用tf.metrics遇到的一些坑。  博客中涉及到的所有代码都已经传到澜子的Github上啦～欢迎互粉哇。  插一句闲话，这一次的博客基本上用的都是 Jupyter，感觉一级好用啊。可以一边写代码，一边记markdown，忍不住上一张效果图，再次欢迎大噶去我的Github">
<meta name="keywords" content="Tensorflow">
<meta property="og:type" content="article">
<meta property="og:title" content="Tensorflow_tf_metrics_continue">
<meta property="og:url" content="http://yoursite.com/2018/08/23/Tensorflow-tf-metrics-continue/index.html">
<meta property="og:site_name" content="Hong Lan">
<meta property="og:description" content="欠下的帐总归还是要还的，之前一直拖着，总是懒得写tf.metrics这个API的一些用法，今天总算是克服了懒癌，总结一下用tf.metrics遇到的一些坑。  博客中涉及到的所有代码都已经传到澜子的Github上啦～欢迎互粉哇。  插一句闲话，这一次的博客基本上用的都是 Jupyter，感觉一级好用啊。可以一边写代码，一边记markdown，忍不住上一张效果图，再次欢迎大噶去我的Github">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://yoursite.com/2018/08/23/Tensorflow-tf-metrics-continue/WechatIMG237.png">
<meta property="og:updated_time" content="2018-08-30T07:59:35.222Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tensorflow_tf_metrics_continue">
<meta name="twitter:description" content="欠下的帐总归还是要还的，之前一直拖着，总是懒得写tf.metrics这个API的一些用法，今天总算是克服了懒癌，总结一下用tf.metrics遇到的一些坑。  博客中涉及到的所有代码都已经传到澜子的Github上啦～欢迎互粉哇。  插一句闲话，这一次的博客基本上用的都是 Jupyter，感觉一级好用啊。可以一边写代码，一边记markdown，忍不住上一张效果图，再次欢迎大噶去我的Github">
<meta name="twitter:image" content="http://yoursite.com/2018/08/23/Tensorflow-tf-metrics-continue/WechatIMG237.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/08/23/Tensorflow-tf-metrics-continue/"/>





  <title>Tensorflow_tf_metrics_continue | Hong Lan</title>
  








  
  <script type="text/javascript"
  color="0,0,255" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/lanhongvp" class="github-corner" aria-label="View source on Github">
    <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#FFC0CB; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
    <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
    <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hong Lan</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/23/Tensorflow-tf-metrics-continue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hong Lan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/hl.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hong Lan">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Tensorflow_tf_metrics_continue</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-08-23T10:39:06+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tensorflow/" itemprop="url" rel="index">
                    <span itemprop="name">Tensorflow</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/23/Tensorflow-tf-metrics-continue/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/08/23/Tensorflow-tf-metrics-continue/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>欠下的帐总归还是要还的，之前一直拖着，总是懒得写<code>tf.metrics</code>这个API的一些用法，今天总算是克服了懒癌，总结一下用<code>tf.metrics</code>遇到的一些坑。</p>
<ul>
<li>博客中涉及到的所有代码都已经传到<a href="https://github.com/lanhongvp/tensorflow_metrics_learn" target="_blank" rel="noopener">澜子的Github</a>上啦～欢迎互粉哇。</li>
</ul>
<p>插一句闲话，这一次的博客基本上用的都是 <strong>Jupyter</strong>，感觉一级好用啊。可以一边写代码，一边记markdown，忍不住上一张效果图，再次欢迎大噶去我的<a href="https://github.com/lanhongvp/tensorflow_metrics_learn" target="_blank" rel="noopener">Github</a>上看一看，而且Github支持 <strong>jupyter notebook</strong> 显示，真得效果很好。</p>
<p><img src="/2018/08/23/Tensorflow-tf-metrics-continue/WechatIMG237.png" alt=""></p>
<p>在这篇<a href="https://lanhongvp.github.io/2018/08/15/Tensorflow-tf-metrics/" target="_blank" rel="noopener">伪Tensorflow-tf-metrics</a>中，澜子介绍了<code>tf.metrics</code>中涉及的一些指标和概念，包括：<strong>精确率(precision)，召回率(recall)，准确率(accuracy)，AUC，混淆矩阵(confusion matrix)</strong>。下面先给出官方的API文档，看看这个模块中都有哪些隐藏秘笈。</p>
<ul>
<li><a href="https://tensorflow.google.cn/api_docs/python/tf/metrics" target="_blank" rel="noopener">官方API文档</a></li>
</ul>
<p>看了官方文档之后，大噶可能会发现其中有好多可以调用的函数，不仅有<code>precision</code> / <code>accuracy</code>/ <code>auc</code>/ <code>recall</code>，还有<code>precision_at_k</code> / <code>recall_at_k</code>，更有<code>precision_at_thresholds</code>/ <code>precision_at_top_k</code>/ <code>sparse_precision_at_k</code>…天啦噜，这都是什么呀，澜子已经彻底晕了，到底要怎么用啊（眼冒金星中）。别急，让我一个坑一个坑地告诉你。</p>
<h2 id="划重点"><a href="#划重点" class="headerlink" title="划重点"></a>划重点</h2><p>首先，这篇文章是受到<a href="http://ronny.rest/blog/post_2017_09_11_tf_metrics/" target="_blank" rel="noopener">Ronny Restrepo</a>的启发，<br>这是一篇很好的文章，将<code>tf.metrics.accuracy()</code>讲解滴很清楚，本文就模仿他的思路，验证一下<code>precision</code>的计算。</p>
<h2 id="精确率的计算公式"><a href="#精确率的计算公式" class="headerlink" title="精确率的计算公式"></a>精确率的计算公式</h2><p>$$ Precision = \frac{truePositive}{truePositive + falsePositive} $$</p>
<h2 id="让我们先造点数据，传统算算看"><a href="#让我们先造点数据，传统算算看" class="headerlink" title="让我们先造点数据，传统算算看"></a>让我们先造点数据，传统算算看</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">labels = np.array([[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>],</span><br><span class="line">                   [<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>],</span><br><span class="line">                   [<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>],</span><br><span class="line">                   [<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>]], dtype=np.uint8)</span><br><span class="line"></span><br><span class="line">predictions = np.array([[<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">                        [<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">                        [<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>],</span><br><span class="line">                        [<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>]], dtype=np.uint8)</span><br><span class="line"></span><br><span class="line">n_batches = len(labels)</span><br><span class="line"><span class="comment"># First,calculate precision over entire set of batches </span></span><br><span class="line"><span class="comment"># using formula mentioned above</span></span><br><span class="line">pred_p = (predictions &gt; <span class="number">0</span>).sum()</span><br><span class="line"><span class="comment"># print(pred_p)</span></span><br><span class="line">true_p = (labels*predictions &gt; <span class="number">0</span>).sum()</span><br><span class="line"><span class="comment"># print(true_p)</span></span><br><span class="line">precision = true_p / pred_p</span><br><span class="line">print(<span class="string">"Precision :%1.4f"</span> %(precision))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Precision :0.8889</p>
</blockquote>
<h2 id="上述方法的问题"><a href="#上述方法的问题" class="headerlink" title="上述方法的问题"></a>上述方法的问题</h2><p>由于硬件方面的一些限制，导致此方法不能扩展到大型数据集，比如当数据集很大时，就无法一次性适应内存。<br>因而，为了使其可扩展，我们希望使评估指标能够逐步更新，每批新的预测和标签。 为此，我们需要跟踪两个值。</p>
<ul>
<li>正确预测的正样本数量</li>
<li>预测样本中所有正样本的数量</li>
</ul>
<h2 id="所以我们要这么做"><a href="#所以我们要这么做" class="headerlink" title="所以我们要这么做"></a>所以我们要这么做</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Initialize running variables</span></span><br><span class="line">N_TRUE_P = <span class="number">0</span></span><br><span class="line">N_PRED_P = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specific steps</span></span><br><span class="line"><span class="comment"># Create running variables</span></span><br><span class="line">N_TRUE_P = <span class="number">0</span></span><br><span class="line">N_PRED_P = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset_running_variables</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">""" Resets the previous values of running variables to zero """</span></span><br><span class="line">    <span class="keyword">global</span> N_TRUE_P, N_PRED_P</span><br><span class="line">    N_TRUE_P = <span class="number">0</span></span><br><span class="line">    c = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_running_variables</span><span class="params">(labs, preds)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> N_TRUE_P, N_PRED_P</span><br><span class="line">    N_TRUE_P += ((labs * preds) &gt; <span class="number">0</span>).sum()</span><br><span class="line">    N_PRED_P += (preds &gt; <span class="number">0</span>).sum()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calculate_precision</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> N_TRUE_P, N_PRED_P</span><br><span class="line">    <span class="keyword">return</span> float (N_TRUE_P) / N_PRED_P</span><br></pre></td></tr></table></figure>
<h2 id="怎么用上面的函数呢？"><a href="#怎么用上面的函数呢？" class="headerlink" title="怎么用上面的函数呢？"></a>怎么用上面的函数呢？</h2><p>接下来的两个例子，给出了运用的具体代码，并且可以更好滴帮助我们理解<code>tf.metrics.precision()</code>的计算逻辑以及对应输出所代表的含义</p>
<h3 id="样本整体准确率-直接计算"><a href="#样本整体准确率-直接计算" class="headerlink" title="样本整体准确率(直接计算)"></a>样本整体准确率(直接计算)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Overall precision</span></span><br><span class="line">reset_running_variables()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n_batches):</span><br><span class="line">    update_running_variables(labs=labels[i], preds=predictions[i])</span><br><span class="line"></span><br><span class="line">precision = calculate_precision()</span><br><span class="line">print(<span class="string">"[NP] SCORE: %1.4f"</span> %precision)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[NP] SCORE: 0.8889</p>
</blockquote>
<h3 id="批次准确率-直接计算"><a href="#批次准确率-直接计算" class="headerlink" title="批次准确率(直接计算)"></a>批次准确率(直接计算)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Batch precision</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n_batches):</span><br><span class="line">    reset_running_variables()</span><br><span class="line">    update_running_variables(labs=labels[i], preds=predictions[i])</span><br><span class="line">    prec = calculate_precision()</span><br><span class="line">    print(<span class="string">"- [NP] batch %d score: %1.4f"</span> %(i, prec))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[NP] batch 0 score: 1.0000</span><br><span class="line">[NP] batch 1 score: 1.0000</span><br><span class="line">[NP] batch 2 score: 1.0000</span><br><span class="line">[NP] batch 3 score: 0.6667</span><br></pre></td></tr></table></figure>
<h2 id="不要小瞧这两个变量和三个函数"><a href="#不要小瞧这两个变量和三个函数" class="headerlink" title="不要小瞧这两个变量和三个函数"></a>不要小瞧这两个变量和三个函数</h2><p>上面说了这么多，感觉没有tensorflow的什么事哇，别急，先看一个tensorflow的官方文档</p>
<h3 id="放一个官方的解释"><a href="#放一个官方的解释" class="headerlink" title="放一个官方的解释"></a>放一个官方的解释</h3><p><a href="https://github.com/tensorflow/tensorflow/blob/r1.10/tensorflow/python/ops/metrics_impl.py" target="_blank" rel="noopener">tensorflow/tensorflow/python/ops/metrics_impl.py</a></p>
<ul>
<li>Github代码中precision的解释部分</li>
</ul>
<blockquote>
<p>The <code>precision</code> function creates <strong>two local variables</strong>,<br>  <code>true_positives</code> and <code>false_positives</code>, that are used to compute the precision. This value is ultimately returned as <code>precision</code>, an idempotent operation that simply divides <code>true_positives</code> by the sum of <code>true_positives</code> and <code>false_positives</code>.<br>  For estimation of the metric over a stream of data, the function creates an <code>update_op</code> operation that updates these variables and returns the <code>precision</code>. </p>
</blockquote>
<h3 id="两个变量和-tf-metrics-precision-的关系"><a href="#两个变量和-tf-metrics-precision-的关系" class="headerlink" title="两个变量和 tf.metrics.precision()的关系"></a>两个变量和 <code>tf.metrics.precision()</code>的关系</h3><p>官方文档提及的<strong>two local variables</strong> ：<code>true_postives</code> 和 <code>false_positives</code>分别对应上文定义的两个变量。</p>
<ul>
<li>true_postives–N_TRUE_P</li>
<li>false_postives–N_PRED_P - N_TRUE_P</li>
</ul>
<h3 id="三个函数和头大的update-op"><a href="#三个函数和头大的update-op" class="headerlink" title="三个函数和头大的update_op"></a>三个函数和头大的<code>update_op</code></h3><p>官方文档提及的<code>update_op</code>和<code>precision</code>分别对应上文定义的两个函数</p>
<ul>
<li>precision–calculate_precision()</li>
<li>update_op–update_running_variables()</li>
</ul>
<p>大家不要被这个<code>update_op</code>搞晕，其实从字面来理解就是一个变量更新的操作，上文的代码中，就是通过<code>reset_running_variables()</code>的位置来决定何时对变量进行更新，其实就是对应于<code>tf.variables_initializer()</code>。我之所以一直用错这个API，是因为我将<code>tf.variables_initializer()</code>放在了错误的位置，导致变量没有按照我的预期正常更新，进而结果一直不正确。具体看看tensorflow是怎么实现的吧。</p>
<h3 id="Overall-precision-using-tensorflow"><a href="#Overall-precision-using-tensorflow" class="headerlink" title="Overall precision using tensorflow"></a>Overall precision using tensorflow</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Overall precision using tensorflow</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line">graph = tf.Graph()</span><br><span class="line"><span class="keyword">with</span> graph.as_default():</span><br><span class="line">    <span class="comment"># Placeholders to take in batches onf data</span></span><br><span class="line">    tf_label = tf.placeholder(dtype=tf.int32, shape=[<span class="keyword">None</span>])</span><br><span class="line">    tf_prediction = tf.placeholder(dtype=tf.int32, shape=[<span class="keyword">None</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Define the metric and update operations</span></span><br><span class="line">    tf_metric, tf_metric_update = tf.metrics.precision(tf_label,</span><br><span class="line">                                                      tf_prediction,</span><br><span class="line">                                                      name=<span class="string">"my_metric"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Isolate the variables stored behind the scenes by the metric operation</span></span><br><span class="line">    running_vars = tf.get_collection(tf.GraphKeys.LOCAL_VARIABLES, scope=<span class="string">"my_metric"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Define initializer to initialize/reset running variables</span></span><br><span class="line">    running_vars_initializer = tf.variables_initializer(var_list=running_vars)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.Session(graph=graph) <span class="keyword">as</span> session:</span><br><span class="line">    session.run(tf.global_variables_initializer())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># initialize/reset the running variables</span></span><br><span class="line">    session.run(running_vars_initializer)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n_batches):</span><br><span class="line">        <span class="comment"># Update the running variables on new batch of samples</span></span><br><span class="line">        feed_dict=&#123;tf_label: labels[i], tf_prediction: predictions[i]&#125;</span><br><span class="line">        session.run(tf_metric_update, feed_dict=feed_dict)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Calculate the score</span></span><br><span class="line">    score = session.run(tf_metric)</span><br><span class="line">    print(<span class="string">"[TF] SCORE: %1.4f"</span> %score)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[TF] SCORE: 0.8889</span><br></pre></td></tr></table></figure>
<h3 id="Batch-precision-using-tensorflow"><a href="#Batch-precision-using-tensorflow" class="headerlink" title="Batch precision using tensorflow"></a>Batch precision using tensorflow</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Batch precision using tensorflow</span></span><br><span class="line"><span class="keyword">with</span> tf.Session(graph=graph) <span class="keyword">as</span> session:</span><br><span class="line">    session.run(tf.global_variables_initializer())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n_batches):</span><br><span class="line">        <span class="comment"># Reset the running variables</span></span><br><span class="line">        session.run(running_vars_initializer)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Update the running variables on new batch of samples</span></span><br><span class="line">        feed_dict=&#123;tf_label: labels[i], tf_prediction: predictions[i]&#125;</span><br><span class="line">        session.run(tf_metric_update, feed_dict=feed_dict)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Calculate the score on this batch</span></span><br><span class="line">        score = session.run(tf_metric)</span><br><span class="line">        print(<span class="string">"[TF] batch %d score: %1.4f"</span> %(i, score))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[TF] batch 0 score: 1.0000</span><br><span class="line">[TF] batch 1 score: 1.0000</span><br><span class="line">[TF] batch 2 score: 1.0000</span><br><span class="line">[TF] batch 3 score: 0.6667</span><br></pre></td></tr></table></figure>
<h2 id="再次划重点"><a href="#再次划重点" class="headerlink" title="再次划重点"></a>再次划重点</h2><p>大噶一定要注意</p>
<p><code>session.run(running_vars_initializer)</code></p>
<p><code>score = session.run(tf_metric)</code></p>
<p>这两行代码在计算<strong>整体样本精确度</strong>以及<strong>批次精确度</strong>所在位置的不同。<br>澜子第一次的时候由于粗心，并没有注意两段代码的不同，才会导致<strong>tf计算结果</strong>和<strong>普通计算结果</strong>不一致</p>
<h2 id="还需要注意的点"><a href="#还需要注意的点" class="headerlink" title="还需要注意的点"></a>还需要注意的点</h2><p>不要在一个<code>sess.run()</code>里面同时调用<code>tf_metric</code>和<code>tf_metric_update</code>，<strong>下面的代码是错误的示范</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_ , score = session.run([tf_metric_update,tf_metric],\</span><br><span class="line">                        feed_dict=feed_dict)</span><br></pre></td></tr></table></figure>
<h2 id="update-op究竟返回了什么捏"><a href="#update-op究竟返回了什么捏" class="headerlink" title="update_op究竟返回了什么捏"></a>update_op究竟返回了什么捏</h2><p>此处参考了<br><a href="https://stackoverflow.com/questions/50291916/what-does-the-update-op-return-variable-mean-in-precision-at-k-metric-in-tenso" target="_blank" rel="noopener">stackoverflow的一个回答</a></p>
<p>具体代码如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">rel = tf.placeholder(tf.int64, [<span class="number">1</span>,<span class="number">3</span>])</span><br><span class="line">rec = tf.constant([[<span class="number">7</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">31</span>, <span class="number">88</span>]], tf.int64) </span><br><span class="line">precision, update_op = tf.metrics.precision_at_k(rel, rec, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line">sess.run(tf.local_variables_initializer())</span><br><span class="line"></span><br><span class="line">stream_vars = [i <span class="keyword">for</span> i <span class="keyword">in</span> tf.local_variables()]</span><br><span class="line"><span class="comment">#Get the local variables true_positive and false_positive</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"[PRECSION_1]: "</span>,sess.run(precision, &#123;rel:[[<span class="number">1</span>,<span class="number">5</span>,<span class="number">10</span>]]&#125;)) <span class="comment"># nan</span></span><br><span class="line"><span class="comment">#tf.metrics.precision maintains two variables true_positives </span></span><br><span class="line"><span class="comment">#and  false_positives, each starts at zero.</span></span><br><span class="line"><span class="comment">#so the output at this step is 'nan'</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"[UPDATE_OP_1]:"</span>,sess.run(update_op, &#123;rel:[[<span class="number">1</span>,<span class="number">5</span>,<span class="number">10</span>]]&#125;)) <span class="comment">#0.2</span></span><br><span class="line"><span class="comment">#when the update_op is called, it updates true_positives </span></span><br><span class="line"><span class="comment">#and false_positives using labels and predictions.</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"[STREAM_VARS_1]:"</span>,sess.run(stream_vars)) <span class="comment">#[2.0, 8.0]</span></span><br><span class="line"><span class="comment"># Get true positive rate and false positive rate</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"[PRECISION_1]:"</span>,sess.run(precision,&#123;rel:[[<span class="number">1</span>,<span class="number">10</span>,<span class="number">15</span>]]&#125;)) <span class="comment"># 0.2</span></span><br><span class="line"><span class="comment">#So calling precision will use true_positives and false_positives and outputs 0.2</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"[UPDATE_OP_2]:"</span>,sess.run(update_op,&#123;rel:[[<span class="number">1</span>,<span class="number">10</span>,<span class="number">15</span>]]&#125;)) <span class="comment">#0.15</span></span><br><span class="line"><span class="comment">#the update_op updates the values to the new calculated value 0.15.</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"[STREAM_VARS_2]:"</span>,sess.run(stream_vars)) <span class="comment">#[3.0, 17.0]</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[PRECSION_1]:  nan</span><br><span class="line">[UPDATE_OP_1]: 0.2</span><br><span class="line">[STREAM_VARS_1]: [0.0, 0.0, 0.0, 0.0, 2.0, 8.0]</span><br><span class="line">[PRECISION_1]: 0.2</span><br><span class="line">[UPDATE_OP_2]: 0.15</span><br><span class="line">[STREAM_VARS_2]: [0.0, 0.0, 0.0, 0.0, 3.0, 17.0]</span><br></pre></td></tr></table></figure>
<h2 id="tf-metrics-precision-at-k"><a href="#tf-metrics-precision-at-k" class="headerlink" title="tf.metrics.precision_at_k"></a>tf.metrics.precision_at_k</h2><p>上面的代码中，我们看到运用的是<code>tf.metrics.precision_at_k()</code>这个API，这里的<code>k</code>是什么呢？<br>首先，我们要理解一个概念，究竟什么是<code>Precision at k</code>，这里有两份资料，应该能很好地帮助你理解这个概念。<br>澜子就是看了这两份资料之后，理解了<code>Precision at k</code>的概念的。</p>
<ul>
<li><a href="https://ils.unc.edu/courses/2013_spring/inls509_001/lectures/10-EvaluationMetrics.pdf" target="_blank" rel="noopener">一份PPT</a></li>
<li><a href="https://medium.com/@m_n_malaeb/recall-and-precision-at-k-for-recommender-systems-618483226c54" target="_blank" rel="noopener">一篇博客</a></li>
</ul>
<p>然后我们来看看这个函数是怎么用的，第一步当然要先看看输入啦。</p>
<ul>
<li><a href="https://tensorflow.google.cn/api_docs/python/tf/metrics/precision_at_k" target="_blank" rel="noopener">官方API文档在此</a></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tf.metrics.precision_at_k(</span><br><span class="line">    labels,</span><br><span class="line">    predictions,</span><br><span class="line">    k,</span><br><span class="line">    class_id=<span class="keyword">None</span>,</span><br><span class="line">    weights=<span class="keyword">None</span>,</span><br><span class="line">    metrics_collections=<span class="keyword">None</span>,</span><br><span class="line">    updates_collections=<span class="keyword">None</span>,</span><br><span class="line">    name=<span class="keyword">None</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>我们重点关注<strong>labels,predictions,k</strong>这三个参数，应该可以满足日常简单地使用了。<br>那<strong>labels,predictions,k</strong>的输入形式是什么样的呢？</p>
<p>闲话不说，直接看看上面的栗子。栗子中<code>rel</code>其实对应为<code>labels</code>，<code>rec</code>对应为<code>predictions</code>，那<code>k</code>又是什么意思呢？<br><strong>划重点</strong>：这里的<code>k</code>表明你需要对多少个预测样本进行排序。这样说可能有一点抽象，给一个解释。</p>
<blockquote>
<p>Precision@k = (Recommended items @k that are relevant) / (# Recommended items @k)</p>
</blockquote>
<p>可以先去看一下<br><a href="https://github.com/tensorflow/tensorflow/blob/r1.10/tensorflow/python/ops/metrics_impl.py" target="_blank" rel="noopener">Github</a>，<br>发现其实在<code>tf.metrics.precision_at_k</code>这个函数中，对于<code>predictions</code>会根据输入的<code>k值</code>进行<code>top_k</code>操作。<br>对应上面的代码中，当<code>k=10</code>，即对<code>rec = tf.constant([[7, 5, 10, 6, 3, 1, 8, 12, 31, 88]], tf.int64)</code><br>所有的样本进行排序，进而在函数中实际运用的是<code>rec</code>中<strong>样本数值从大到小排列的索引值</strong>。这样解释应该就能看懂上面代码的意思了。</p>
<p>后来，澜子又在</p>
<ul>
<li><a href="https://stackoverflow.com/questions/44034262/give-me-a-code-example-usage-for-tensorflows-tf-metrics-sparse-average-precisio/52055189#52055189" target="_blank" rel="noopener">stackoverflow</a></li>
<li><a href="https://www.zhihu.com/question/277184041/answer/480219663" target="_blank" rel="noopener">知乎</a></li>
</ul>
<p>看到有人问怎么用<code>tf.metrics.sparse_average_precision_at_k</code>，就又去求是了一波，<br>还完成了<strong>知乎的技术首答以及stackoverflow上第一个赞</strong>，<br>欢迎互粉<a href="https://www.zhihu.com/people/hong-lan-99/activities" target="_blank" rel="noopener">知乎</a><br>和<a href="https://stackoverflow.com/users/8403323/hong-lan" target="_blank" rel="noopener">stackoverflow</a>哇。下面给出栗子和简单解释啦。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">y_true = np.array([[<span class="number">2</span>], [<span class="number">1</span>], [<span class="number">0</span>], [<span class="number">3</span>], [<span class="number">0</span>]]).astype(np.int64)</span><br><span class="line">y_true = tf.identity(y_true)</span><br><span class="line"></span><br><span class="line">y_pred = np.array([[<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.6</span>, <span class="number">0.1</span>],</span><br><span class="line">                   [<span class="number">0.8</span>, <span class="number">0.05</span>, <span class="number">0.1</span>, <span class="number">0.05</span>],</span><br><span class="line">                   [<span class="number">0.3</span>, <span class="number">0.4</span>, <span class="number">0.1</span>, <span class="number">0.2</span>],</span><br><span class="line">                   [<span class="number">0.6</span>, <span class="number">0.25</span>, <span class="number">0.1</span>, <span class="number">0.05</span>],</span><br><span class="line">                   [<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.6</span>, <span class="number">0.1</span>]</span><br><span class="line">                   ]).astype(np.float32)</span><br><span class="line">y_pred = tf.identity(y_pred)</span><br><span class="line"></span><br><span class="line">_, m_ap = tf.metrics.sparse_average_precision_at_k(y_true, y_pred, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">sess = tf.Session()</span><br><span class="line">sess.run(tf.local_variables_initializer())</span><br><span class="line"></span><br><span class="line">stream_vars = [i <span class="keyword">for</span> i <span class="keyword">in</span> tf.local_variables()]</span><br><span class="line"></span><br><span class="line">tf_map = sess.run(m_ap)</span><br><span class="line">print(<span class="string">"TF_MAP"</span>,tf_map)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"STREAM_VARS"</span>,(sess.run(stream_vars)))</span><br><span class="line"></span><br><span class="line">tmp_rank = tf.nn.top_k(y_pred,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"TMP_RANK"</span>,sess.run(tmp_rank))</span><br></pre></td></tr></table></figure>
<h2 id="简单解释一下"><a href="#简单解释一下" class="headerlink" title="简单解释一下"></a>简单解释一下</h2><ul>
<li><p>首先<code>y_true</code>代表标签值（未经过<strong>one-hot</strong>），<code>shape：(batch_size, num_labels)</code> ,<code>y_pred</code>代表预测值（<strong>logit值</strong>） ，<code>shape：(batch_size, num_classes)</code></p>
</li>
<li><p>其次，要注意的是<code>tf.metrics.sparse_average_precision_at_k</code>中会采用<code>top_k</code>根据不同的<code>k值</code>对<code>y_pred</code>进行排序操作 ，所以<code>tmp_rank</code>是为了帮助大噶理解究竟y_pred在函数中进行了怎样的转换。</p>
</li>
<li><p>然后，<code>stream_vars = [i for i in tf.local_variables()]</code>这一行是为了帮助大噶理解 <code>tf.metrics.sparse_average_precision_at_k</code>创建的<code>tf.local_varibles</code> 实际输出值，进而可以更好地理解这个函数的用法。</p>
</li>
<li><p>具体看这个例子，当<code>k=1</code>时，只有第一个<strong>batch的预测输出是和标签匹配的</strong> ，所以最终输出为：<code>1/6 = 0.166666</code> ；当<code>k=2</code>时，<strong>除了第一个batch的预测输出，第三个batch的预测输出也是和标签匹配的</strong>，所以最终输出为：<code>(1+(1/2))/6 = 0.25。</code></p>
</li>
</ul>
<p><strong>P.S:在以后的tf版本里，将<code>tf.metrics.average_precision_at_k</code>替代<code>tf.metrics.sparse_average_precision_at_k</code></strong></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Tensorflow/" rel="tag"><i class="fa fa-tag"></i>Tensorflow</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/21/Tensorflow-tf-data/" rel="next" title="Tensorflow_tf_data">
                <i class="fa fa-chevron-left"></i> Tensorflow_tf_data
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/hl.jpeg"
                alt="Hong Lan" />
            
              <p class="site-author-name" itemprop="name">Hong Lan</p>
              <p class="site-description motion-element" itemprop="description">Tomorrow is another day</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/lanhongvp" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/lanhong66244438" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/profile.php?id=100027933293465" target="_blank" title="FB Page">
                      
                        <i class="fa fa-fw fa-facebook"></i>FB Page</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/charlotte_laner" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#划重点"><span class="nav-number">1.</span> <span class="nav-text">划重点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#精确率的计算公式"><span class="nav-number">2.</span> <span class="nav-text">精确率的计算公式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#让我们先造点数据，传统算算看"><span class="nav-number">3.</span> <span class="nav-text">让我们先造点数据，传统算算看</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#上述方法的问题"><span class="nav-number">4.</span> <span class="nav-text">上述方法的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#所以我们要这么做"><span class="nav-number">5.</span> <span class="nav-text">所以我们要这么做</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#怎么用上面的函数呢？"><span class="nav-number">6.</span> <span class="nav-text">怎么用上面的函数呢？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#样本整体准确率-直接计算"><span class="nav-number">6.1.</span> <span class="nav-text">样本整体准确率(直接计算)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#批次准确率-直接计算"><span class="nav-number">6.2.</span> <span class="nav-text">批次准确率(直接计算)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#不要小瞧这两个变量和三个函数"><span class="nav-number">7.</span> <span class="nav-text">不要小瞧这两个变量和三个函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#放一个官方的解释"><span class="nav-number">7.1.</span> <span class="nav-text">放一个官方的解释</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#两个变量和-tf-metrics-precision-的关系"><span class="nav-number">7.2.</span> <span class="nav-text">两个变量和 tf.metrics.precision()的关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三个函数和头大的update-op"><span class="nav-number">7.3.</span> <span class="nav-text">三个函数和头大的update_op</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Overall-precision-using-tensorflow"><span class="nav-number">7.4.</span> <span class="nav-text">Overall precision using tensorflow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Batch-precision-using-tensorflow"><span class="nav-number">7.5.</span> <span class="nav-text">Batch precision using tensorflow</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#再次划重点"><span class="nav-number">8.</span> <span class="nav-text">再次划重点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#还需要注意的点"><span class="nav-number">9.</span> <span class="nav-text">还需要注意的点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#update-op究竟返回了什么捏"><span class="nav-number">10.</span> <span class="nav-text">update_op究竟返回了什么捏</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tf-metrics-precision-at-k"><span class="nav-number">11.</span> <span class="nav-text">tf.metrics.precision_at_k</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#简单解释一下"><span class="nav-number">12.</span> <span class="nav-text">简单解释一下</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-reddit-alien"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hong Lan</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'KufiThL2Cr1MCGJGI4r2B2e6-gzGzoHsz',
        appKey: 'NIb0Q6tYzMgps4y8ENCfQkiA',
        placeholder: 'Say something to me',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
<!-- love heart -->
<script type="text/javascript" src="/js/src/love.js"></script>
